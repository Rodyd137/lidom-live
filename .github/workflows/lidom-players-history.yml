name: scrape-lidom-players-history

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/30 * * * *"   # cada 30 min

permissions:
  contents: write

concurrency:
  group: scrape-lidom-players-history
  cancel-in-progress: true

env:
  TZ: America/Santo_Domingo
  LIDOM_STATS_URL: https://estadisticas.lidom.com/Lider
  HIST_CONCURRENCY: "3"
  HIST_DELAY_MS: "300"
  HIST_MAX_SEASONS: "0"
  HIST_IDS_PER_RUN: "60"
  ALLOW_INSECURE_TLS: "1"

jobs:
  history:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0   # para rebase y ver progreso anterior

      - name: Re-auth + pull latest
        run: |
          set -euo pipefail
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git config pull.rebase true
          git pull --rebase origin "${GITHUB_REF_NAME:-main}" || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps (docs/)
        run: |
          if [ -f docs/package-lock.json ]; then
            npm ci --prefix docs
          else
            npm i --prefix docs --no-fund --no-audit
          fi
          [ -e node_modules ] || ln -s docs/node_modules node_modules

      - name: Locate script
        id: findhist
        shell: bash
        run: |
          set -euo pipefail
          for p in scripts/lidom_players_history.mjs lidom_players_history.mjs tools/lidom_players_history.mjs src/scripts/lidom_players_history.mjs; do
            if [ -f "$p" ]; then echo "history=$p" >> "$GITHUB_OUTPUT"; exit 0; fi
          done
          echo "ERROR: falta lidom_players_history.mjs"; exit 1

      - name: Run players history (batch resume)
        env:
          TZ: ${{ env.TZ }}
          LIDOM_STATS_URL: ${{ env.LIDOM_STATS_URL }}
          HIST_CONCURRENCY: ${{ env.HIST_CONCURRENCY }}
          HIST_DELAY_MS: ${{ env.HIST_DELAY_MS }}
          HIST_MAX_SEASONS: ${{ env.HIST_MAX_SEASONS }}
          HIST_IDS_PER_RUN: ${{ env.HIST_IDS_PER_RUN }}
          ALLOW_INSECURE_TLS: ${{ env.ALLOW_INSECURE_TLS }}
        run: node "${{ steps.findhist.outputs.history }}"

      # ====== DEBUG: ver qué se generó antes de commitear ======
      - name: Debug: listar archivos generados
        shell: bash
        run: |
          set -euo pipefail
          echo "== Conteos =="
          find docs/stats/jugadores_history/by_id -type f -name '*.json' 2>/dev/null | wc -l || true
          test -f docs/stats/jugadores_history.json && wc -c docs/stats/jugadores_history.json || true
          echo "== 3 ejemplos by_id =="
          ls -1 docs/stats/jugadores_history/by_id | head -n 3 || true
          echo "== git status (antes) =="
          git status -sb || true

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit & push (forzado, con branch correcto)
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${GITHUB_REF_NAME:-main}"
          mkdir -p docs/stats/jugadores_history/by_id

          # 1) Staging **forzado**
          git add -A -f docs/stats/jugadores_history
          git add -f docs/stats/jugadores_history.json 2>/dev/null || true

          echo "== git status (staged) =="
          git status -sb || true
          echo "== diff --cached (primeras 50 líneas) =="
          git diff --cached --name-status | head -n 50 || true

          # 2) Si NO hay nada staged, salir
          if git diff --cached --quiet; then
            echo "Sin cambios para commit."
            exit 0
          fi

          # 3) Commit + rebase + push
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          git commit -m "chore(players-history): batch ${TS} [skip ci]" || true
          git pull --rebase origin "$BRANCH" || true

          # 4) Push; retry suave si falla
          git push origin HEAD:"$BRANCH" || {
            echo "Push falló; intento 2 con reset suave…"
            git fetch origin "$BRANCH"
            git reset --soft "origin/$BRANCH" || true
            git add -A -f docs/stats/jugadores_history docs/stats/jugadores_history.json || true
            git commit -m "chore(players-history): batch ${TS} [skip ci]" || true
            git push origin HEAD:"$BRANCH"
          }
