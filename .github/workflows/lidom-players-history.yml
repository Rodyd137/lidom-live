name: scrape-lidom-players-history

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/30 * * * *"   # cada 30 min

permissions:
  contents: write

concurrency:
  group: scrape-lidom-players-history
  cancel-in-progress: true

env:
  TZ: America/Santo_Domingo
  LIDOM_STATS_URL: https://estadisticas.lidom.com/Lider
  HIST_CONCURRENCY: "3"
  HIST_DELAY_MS: "300"
  HIST_MAX_SEASONS: "0"
  HIST_IDS_PER_RUN: "60"
  ALLOW_INSECURE_TLS: "1"

jobs:
  history:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0   # para rebase y ver progreso anterior

      - name: Re-auth remote + pull latest
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git pull --rebase origin main || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps (docs/)
        run: |
          if [ -f docs/package-lock.json ]; then
            npm ci --prefix docs
          else
            npm i --prefix docs --no-fund --no-audit
          fi
          [ -e node_modules ] || ln -s docs/node_modules node_modules

      - name: Locate script
        id: findhist
        shell: bash
        run: |
          set -euo pipefail
          for p in scripts/lidom_players_history.mjs lidom_players_history.mjs tools/lidom_players_history.mjs src/scripts/lidom_players_history.mjs; do
            if [ -f "$p" ]; then echo "history=$p" >> "$GITHUB_OUTPUT"; exit 0; fi
          done
          echo "ERROR: falta lidom_players_history.mjs"; exit 1

      - name: Run players history (batch resume)
        env:
          TZ: ${{ env.TZ }}
          LIDOM_STATS_URL: ${{ env.LIDOM_STATS_URL }}
          HIST_CONCURRENCY: ${{ env.HIST_CONCURRENCY }}
          HIST_DELAY_MS: ${{ env.HIST_DELAY_MS }}
          HIST_MAX_SEASONS: ${{ env.HIST_MAX_SEASONS }}
          HIST_IDS_PER_RUN: ${{ env.HIST_IDS_PER_RUN }}
          ALLOW_INSECURE_TLS: ${{ env.ALLOW_INSECURE_TLS }}
        run: node "${{ steps.findhist.outputs.history }}"

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit & push (by_id + merged)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/stats/jugadores_history/by_id

          echo "== Cambios en disco =="
          ls -lh docs/stats/jugadores_history/by_id | tail -n +1 || true
          [ -f docs/stats/jugadores_history.json ] && wc -c docs/stats/jugadores_history.json || true

          # 1) Staging primero (incluye nuevos y fuerza si hay .gitignore)
          git add -f docs/stats/jugadores_history/by_id/*.json 2>/dev/null || true
          git add -f docs/stats/jugadores_history.json 2>/dev/null || true
          git add -f docs/stats/jugadores_history/ 2>/dev/null || true

          # 2) Â¿Hay algo staged?
          if git diff --cached --quiet; then
            echo "Sin cambios para commit."
            exit 0
          fi

          # 3) Commit + rebase + push
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          git commit -m "chore(players-history): batch ${TS} [skip ci]" || true
          git pull --rebase origin main || true
          git push origin HEAD:main || true

